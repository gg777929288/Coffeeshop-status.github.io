<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新成員啟用分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .chart-container {
            position: relative;
            height: 60vh;
            margin: 20px 0;
        }
        .description {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .view-controls {
            margin: 20px 0;
            text-align: center;
        }
        .view-controls button {
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
        }
        .view-controls button.active {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <h1>新成��啟用分析</h1>
    
    <div class="description">
        <h2>什麼是啟用？</h2>
        <p>當新成員了解社群的主題以及為什麼適合他們時，我們認為該成員已「啟用」。通常這表現在他們至少發送了一條訊息或探索了初始頻道之外的其他頻道。</p>
        <p>未啟用的新成員往往會持續保持不活躍狀態，所以我們需要改善這一點。您可以如何讓新成員更容易融入您的社群？</p>
        <p><strong>提示：</strong>如果圖表看起來數據波動很大，可能是因為每日新加入的成員數量不足。請嘗試切換為週視圖或月視圖。</p>
    </div>

    <div class="view-controls">
        <button onclick="changeView('daily')" class="active">日視圖</button>
        <button onclick="changeView('weekly')">週視圖</button>
        <button onclick="changeView('monthly')">月視圖</button>
    </div>

    <div class="chart-container">
        <canvas id="activationChart"></canvas>
    </div>

    <script>
        let myChart;
        let originalData;

        function aggregateData(data, period) {
            if (period === 'daily') return data;

            const aggregated = {};
            data.forEach(item => {
                let key;
                const date = new Date(item.date);
                
                if (period === 'weekly') {
                    // 修正: 確保使用 ISO 週格式
                    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                    const weekNumber = Math.ceil((((date - firstDayOfYear) / 86400000) + firstDayOfYear.getDay() + 1) / 7);
                    key = `${date.getFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
                } else if (period === 'monthly') {
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }

                if (!aggregated[key]) {
                    aggregated[key] = {
                        date: key,
                        members: 0,
                        openedTotal: 0,
                        openedCount: 0,
                        communicatedTotal: 0,
                        communicatedCount: 0
                    };
                }

                aggregated[key].members += item.members;
                
                if (typeof item.opened === 'number' && !isNaN(item.opened)) {
                    aggregated[key].openedTotal += item.opened;
                    aggregated[key].openedCount++;
                }
                
                if (typeof item.communicated === 'number' && !isNaN(item.communicated)) {
                    aggregated[key].communicatedTotal += item.communicated;
                    aggregated[key].communicatedCount++;
                }
            });

            return Object.values(aggregated)
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(item => ({
                    date: item.date,
                    members: item.members,
                    opened: item.openedCount > 0 ? item.openedTotal / item.openedCount : 0,
                    communicated: item.communicatedCount > 0 ? item.communicatedTotal / item.communicatedCount : 0
                }));
        }

        function changeView(period) {
            document.querySelectorAll('.view-controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`button[onclick="changeView('${period}')"]`).classList.add('active');

            const aggregatedData = aggregateData(originalData, period);
            updateChart(aggregatedData);
        }

        function updateChart(data) {
            if (myChart) {
                myChart.destroy();
            }

            const ctx = document.getElementById('activationChart').getContext('2d');
            myChart = new Chart(ctx, {
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: '新成員數量',
                        data: data.map(d => d.members),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        type: 'bar'
                    }, {
                        label: '開啟頻道比例 (%)',
                        data: data.map(d => d.opened),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        type: 'line',
                        yAxisID: 'percentage'
                    }, {
                        label: '互動比例 (%)',
                        data: data.map(d => d.communicated),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        type: 'line',
                        yAxisID: 'percentage'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '新成員數量'
                            }
                        },
                        percentage: {
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '百分比'
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'ctrl',
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(225,225,225,0.3)'
                                }
                            }
                        }
                    }
                }
            });
        }

        const csvData = `day_pt,new_members,pct_opened_channels,interval_start_timestamp,pct_communicated
2024-08-06T00:00:00+00:00,6,66.66666666666666,2024-08-06T00:00:00+00:00,0
2024-08-07T00:00:00+00:00,1,0,2024-08-07T00:00:00+00:00,100
2024-08-08T00:00:00+00:00,4,100,2024-08-08T00:00:00+00:00,25
2024-08-09T00:00:00+00:00,3,33.33333333333333,2024-08-09T00:00:00+00:00,0
2024-08-10T00:00:00+00:00,1,100,2024-08-10T00:00:00+00:00,0
2024-08-11T00:00:00+00:00,4,75,2024-08-11T00:00:00+00:00,50
2024-08-12T00:00:00+00:00,7,85.71428571428571,2024-08-12T00:00:00+00:00,28.57142857142857
2024-08-13T00:00:00+00:00,3,66.66666666666666,2024-08-13T00:00:00+00:00,0
2024-08-14T00:00:00+00:00,1,100,2024-08-14T00:00:00+00:00,100
2024-08-15T00:00:00+00:00,6,16.666666666666664,2024-08-15T00:00:00+00:00,16.666666666666664
2024-08-16T00:00:00+00:00,7,85.71428571428571,2024-08-16T00:00:00+00:00,42.857142857142854
2024-08-17T00:00:00+00:00,3,33.33333333333333,2024-08-17T00:00:00+00:00,33.33333333333333
2024-08-18T00:00:00+00:00,2,100,2024-08-18T00:00:00+00:00,0
2024-08-19T00:00:00+00:00,5,40,2024-08-19T00:00:00+00:00,60
2024-08-20T00:00:00+00:00,1,100,2024-08-20T00:00:00+00:00,0
2024-08-21T00:00:00+00:00,7,57.14285714285714,2024-08-21T00:00:00+00:00,0
2024-08-22T00:00:00+00:00,1,0,2024-08-22T00:00:00+00:00,0
2024-08-23T00:00:00+00:00,33,87.87878787878788,2024-08-23T00:00:00+00:00,30.303030303030305
2024-08-24T00:00:00+00:00,19,78.94736842105263,2024-08-24T00:00:00+00:00,10.526315789473683
2024-08-25T00:00:00+00:00,24,70.83333333333334,2024-08-25T00:00:00+00:00,12.5
2024-08-26T00:00:00+00:00,9,66.66666666666666,2024-08-26T00:00:00+00:00,22.22222222222222
2024-08-27T00:00:00+00:00,8,87.5,2024-08-27T00:00:00+00:00,0
2024-08-28T00:00:00+00:00,6,66.66666666666666,2024-08-28T00:00:00+00:00,16.666666666666664
2024-08-29T00:00:00+00:00,8,75,2024-08-29T00:00:00+00:00,37.5
2024-08-30T00:00:00+00:00,10,60,2024-08-30T00:00:00+00:00,40
2024-08-31T00:00:00+00:00,5,40,2024-08-31T00:00:00+00:00,0
2024-09-01T00:00:00+00:00,9,88.88888888888889,2024-09-01T00:00:00+00:00,11.11111111111111
2024-09-02T00:00:00+00:00,8,50,2024-09-02T00:00:00+00:00,12.5
2024-09-03T00:00:00+00:00,2,50,2024-09-03T00:00:00+00:00,50
2024-09-04T00:00:00+00:00,3,66.66666666666666,2024-09-04T00:00:00+00:00,33.33333333333333
2024-09-05T00:00:00+00:00,5,40,2024-09-05T00:00:00+00:00,40
2024-09-06T00:00:00+00:00,11,72.72727272727273,2024-09-06T00:00:00+00:00,9.090909090909092
2024-09-07T00:00:00+00:00,12,100,2024-09-07T00:00:00+00:00,33.33333333333333
2024-09-08T00:00:00+00:00,8,100,2024-09-08T00:00:00+00:00,50
2024-09-09T00:00:00+00:00,15,80,2024-09-09T00:00:00+00:00,33.33333333333333
2024-09-10T00:00:00+00:00,29,82.75862068965517,2024-09-10T00:00:00+00:00,20.689655172413794
2024-09-11T00:00:00+00:00,11,36.36363636363637,2024-09-11T00:00:00+00:00,18.181818181818183
2024-09-12T00:00:00+00:00,21,57.14285714285714,2024-09-12T00:00:00+00:00,28.57142857142857
2024-09-13T00:00:00+00:00,5,60,2024-09-13T00:00:00+00:00,40
2024-09-14T00:00:00+00:00,6,66.66666666666666,2024-09-14T00:00:00+00:00,66.66666666666666
2024-09-15T00:00:00+00:00,3,66.66666666666666,2024-09-15T00:00:00+00:00,33.33333333333333
2024-09-16T00:00:00+00:00,4,75,2024-09-16T00:00:00+00:00,25
2024-09-17T00:00:00+00:00,3,66.66666666666666,2024-09-17T00:00:00+00:00,66.66666666666666
2024-09-18T00:00:00+00:00,10,70,2024-09-18T00:00:00+00:00,20
2024-09-19T00:00:00+00:00,3,66.66666666666666,2024-09-19T00:00:00+00:00,0
2024-09-20T00:00:00+00:00,8,87.5,2024-09-20T00:00:00+00:00,25
2024-09-21T00:00:00+00:00,19,94.73684210526315,2024-09-21T00:00:00+00:00,31.57894736842105
2024-09-22T00:00:00+00:00,8,100,2024-09-22T00:00:00+00:00,12.5
2024-09-23T00:00:00+00:00,9,77.77777777777779,2024-09-23T00:00:00+00:00,33.33333333333333
2024-09-24T00:00:00+00:00,7,85.71428571428571,2024-09-24T00:00:00+00:00,42.857142857142854
2024-09-25T00:00:00+00:00,18,88.88888888888889,2024-09-25T00:00:00+00:00,22.22222222222222
2024-09-26T00:00:00+00:00,4,75,2024-09-26T00:00:00+00:00,25
2024-09-27T00:00:00+00:00,5,60,2024-09-27T00:00:00+00:00,60
2024-09-28T00:00:00+00:00,2,50,2024-09-28T00:00:00+00:00,0
2024-09-29T00:00:00+00:00,3,33.33333333333333,2024-09-29T00:00:00+00:00,33.33333333333333
2024-09-30T00:00:00+00:00,19,78.94736842105263,2024-09-30T00:00:00+00:00,36.84210526315789
2024-10-01T00:00:00+00:00,9,100,2024-10-01T00:00:00+00:00,22.22222222222222
2024-10-02T00:00:00+00:00,78,85.8974358974359,2024-10-02T00:00:00+00:00,34.61538461538461
2024-10-03T00:00:00+00:00,13,76.92307692307693,2024-10-03T00:00:00+00:00,23.076923076923077
2024-10-04T00:00:00+00:00,12,75,2024-10-04T00:00:00+00:00,25
2024-10-05T00:00:00+00:00,4,75,2024-10-05T00:00:00+00:00,50
2024-10-06T00:00:00+00:00,13,84.61538461538461,2024-10-06T00:00:00+00:00,7.6923076923076925
2024-10-07T00:00:00+00:00,7,42.857142857142854,2024-10-07T00:00:00+00:00,14.285714285714285
2024-10-08T00:00:00+00:00,3,33.33333333333333,2024-10-08T00:00:00+00:00,33.33333333333333
2024-10-09T00:00:00+00:00,5,80,2024-10-09T00:00:00+00:00,40
2024-10-10T00:00:00+00:00,4,50,2024-10-10T00:00:00+00:00,25
2024-10-11T00:00:00+00:00,4,50,2024-10-11T00:00:00+00:00,25
2024-10-12T00:00:00+00:00,10,80,2024-10-12T00:00:00+00:00,0
2024-10-13T00:00:00+00:00,0,0,2024-10-13T00:00:00+00:00,0
2024-10-14T00:00:00+00:00,5,20,2024-10-14T00:00:00+00:00,0
2024-10-15T00:00:00+00:00,1,0,2024-10-15T00:00:00+00:00,0
2024-10-16T00:00:00+00:00,6,83.33333333333334,2024-10-16T00:00:00+00:00,50
2024-10-17T00:00:00+00:00,1,0,2024-10-17T00:00:00+00:00,0
2024-10-18T00:00:00+00:00,4,50,2024-10-18T00:00:00+00:00,0
2024-10-19T00:00:00+00:00,1,100,2024-10-19T00:00:00+00:00,0
2024-10-20T00:00:00+00:00,4,50,2024-10-20T00:00:00+00:00,0
2024-10-21T00:00:00+00:00,9,66.66666666666666,2024-10-21T00:00:00+00:00,0
2024-10-22T00:00:00+00:00,4,75,2024-10-22T00:00:00+00:00,25
2024-10-23T00:00:00+00:00,5,40,2024-10-23T00:00:00+00:00,0
2024-10-24T00:00:00+00:00,2,50,2024-10-24T00:00:00+00:00,50
2024-10-25T00:00:00+00:00,2,50,2024-10-25T00:00:00+00:00,0
2024-10-26T00:00:00+00:00,1,0,2024-10-26T00:00:00+00:00,0
2024-10-27T00:00:00+00:00,4,25,2024-10-27T00:00:00+00:00,0
2024-10-28T00:00:00+00:00,1,100,2024-10-28T00:00:00+00:00,0
2024-10-29T00:00:00+00:00,1,100,2024-10-29T00:00:00+00:00,0
2024-10-30T00:00:00+00:00,4,50,2024-10-30T00:00:00+00:00,25
2024-10-31T00:00:00+00:00,3,66.66666666666666,2024-10-31T00:00:00+00:00,33.33333333333333
2024-11-01T00:00:00+00:00,2,50,2024-11-01T00:00:00+00:00,0
2024-11-02T00:00:00+00:00,5,60,2024-11-02T00:00:00+00:00,20
2024-11-03T00:00:00+00:00,3,66.66666666666666,2024-11-03T00:00:00+00:00,33.33333333333333
2024-11-04T00:00:00+00:00,4,75,2024-11-04T00:00:00+00:00,25
2024-11-05T00:00:00+00:00,3,66.66666666666666,2024-11-05T00:00:00+00:00,100
2024-11-06T00:00:00+00:00,2,50,2024-11-06T00:00:00+00:00
2024-11-07T00:00:00+00:00,0,,2024-11-07T00:00:00+00:00
2024-11-08T00:00:00+00:00,4,25,2024-11-08T00:00:00+00:00
2024-11-09T00:00:00+00:00,4,100,2024-11-09T00:00:00+00:00
2024-11-10T00:00:00+00:00,0,,2024-11-10T00:00:00+00:00
2024-11-11T00:00:00+00:00,1,100,2024-11-11T00:00:00+00:00
2024-11-12T00:00:00+00:00,2,50,2024-11-12T00:00:00+00:00
2024-11-13T00:00:00+00:00,1,100,2024-11-13T00:00:00+00:00,100
2024-11-14T00:00:00+00:00,2,,2024-11-14T00:00:00+00:00
2024-11-15T00:00:00+00:00,6,66.66666666666666,2024-11-15T00:00:00+00:00,33.33333333333333
2024-11-16T00:00:00+00:00,8,75,2024-11-16T00:00:00+00:00,12.5
2024-11-17T00:00:00+00:00,8,62.5,2024-11-17T00:00:00+00:00,25
2024-11-18T00:00:00+00:00,1,,2024-11-18T00:00:00+00:00,100
2024-11-19T00:00:00+00:00,4,50,2024-11-19T00:00:00+00:00
2024-11-20T00:00:00+00:00,4,50,2024-11-20T00:00:00+00:00,50
2024-11-21T00:00:00+00:00,1,100,2024-11-21T00:00:00+00:00,100
2024-11-22T00:00:00+00:00,4,50,2024-11-22T00:00:00+00:00
2024-11-23T00:00:00+00:00,1,100,2024-11-23T00:00:00+00:00
2024-11-24T00:00:00+00:00,2,100,2024-11-24T00:00:00+00:00
2024-11-25T00:00:00+00:00,2,50,2024-11-25T00:00:00+00:00,100
2024-11-26T00:00:00+00:00,1,,2024-11-26T00:00:00+00:00
2024-11-27T00:00:00+00:00,5,60,2024-11-27T00:00:00+00:00,20
2024-11-28T00:00:00+00:00,2,100,2024-11-28T00:00:00+00:00
2024-11-29T00:00:00+00:00,2,100,2024-11-29T00:00:00+00:00,50
2024-11-30T00:00:00+00:00,5,100,2024-11-30T00:00:00+00:00,20
2024-12-01T00:00:00+00:00,3,33.33333333333333,2024-12-01T00:00:00+00:00
`;
        const rows = csvData.split('\n').slice(1);
        originalData = rows.map(row => {
            const [date, members, opened, timestamp, communicated] = row.split(',');
            return {
                date: date.split('T')[0],
                members: parseInt(members) || 0,
                opened: opened ? parseFloat(opened) : 0,
                communicated: communicated ? parseFloat(communicated) : 0
            };
        });
        changeView('daily');
    </script>
</body>
</html>